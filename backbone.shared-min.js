(function(){var t={}.hasOwnProperty,r=function(r,o){function e(){this.constructor=r}for(var i in o)t.call(o,i)&&(r[i]=o[i]);return e.prototype=o.prototype,r.prototype=new e,r.__super__=o.prototype,r};Backbone.SharedModel=function(t){function o(t,r){o.__super__.constructor.call(this,t,r),this.doc=null!=r?r.doc:void 0,(null!=r?r.root:void 0)&&(this.root=r.root),this.root&&this.initializeSharing()}return r(o,t),o.prototype.root=!1,o.prototype.initializeSharing=function(){var t=this;return this.root||(this.doc=this.collection.doc),this.sharedCollections&&_.each(this.sharedCollections,function(r){var o;return null!=(o=t[r])?o.initializeSharing({parent:t,doc:t.doc}):void 0}),this.sharedAttributes&&_.each(this.sharedAttributesKeys,function(r){return t.on("change:"+r,function(o,e){return t.updateSharedAttr(r,t._previousAttributes[r],e)})}),this.on("destroy",this.destroyed,this)},o.prototype.sharePath=function(){var t;return(null!=(t=this.collection)?t.sharePath().concat([this.index]):void 0)||[]},o.prototype.subDoc=function(){return this.doc.at(this.sharePath())},o.prototype.attrSubdoc=function(t){return this.subDoc().at([t])},o.prototype.sharedAttributes=function(){return _.pick(this.attributes,this.sharedAttributesKeys)},o.prototype.updateSharedAttr=function(t,r,o){return this.attrSubdoc(t).set(o)},o.prototype.destroyed=function(t,r,o){return(null!=o?o.fromSharedOp:void 0)?void 0:this.subDoc().remove()},o.prototype.applySharedAction=function(t){var r=this;return _.each(t,function(t){return t.li&&r.insertModel(t),t.oi&&r.setAttributeOrCollection(t),t.ld?r.destroyModel(t):void 0})},o.prototype.resourceAt=function(t){var r;return r=function(t,r){return _.isNumber(r)?t.models[r]:t[r]},_.reduce(t,r,this)},o.prototype.insertModel=function(t){var r;return r=this.resourceAt(_.initial(t.p)),r.add(t.li,{fromSharedOp:!0})},o.prototype.destroyModel=function(t){var r;return r=this.resourceAt(t.p),r.destroy({fromSharedOp:!0})},o.prototype.setAttributeOrCollection=function(t){var r,o,e;return e=this.resourceAt(_.initial(t.p)),o=_.last(t.p),(r=e[o])&&_.contains(e.sharedCollections,o)?r.reset(t.oi,{silent:!1,fromSharedOp:!0}):e.set(o,t.oi)},o}(Backbone.Model),Backbone.SharedCollection=function(t){function o(t,r){var e=this;o.__super__.constructor.call(this,t,r),this.on("add destroy",function(){return e.processIndexes()}),this.on("reset",function(){return e.setDoc()})}return r(o,t),o.prototype.path=null,o.prototype.initializeSharing=function(t){var r,o=this;return this.on("add",this.triggerSharedAdd,this),this.parent=t.parent,this.setDoc(t.doc),this.processIndexes(),r=!this.subDoc().get(),_.each(this.models,function(t){return r&&o.modelAdded(t),t.initializeSharing()})},o.prototype.subDoc=function(){return this.doc.at(this.sharePath())},o.prototype.setDoc=function(t){var r;null==t&&(t=null),t&&(this.doc=t);try{if(this.subDoc().get(),r=this.sharePath().join("-"),this.listening!==r)return this.listening=r}catch(o){}},o.prototype.sharePath=function(){return this.parent.sharePath().concat([this.path])},o.prototype.processIndexes=function(){return this.each(function(t,r){return t.index=r,t.trigger("indexed")})},o.prototype.modelAdded=function(t){return void 0===this.subDoc().get()?(this.subDoc().set([t.sharedAttributes()]),this.setDoc()):this.subDoc().push(t.sharedAttributes())},o.prototype.triggerSharedAdd=function(t,r,o){return t.root||t.collection?(o&&o.fromSharedOp||this.modelAdded(t),t.initializeSharing()):void 0},o}(Backbone.Collection)}).call(this);