(function(){var t={}.hasOwnProperty,e=function(e,r){function o(){this.constructor=e}for(var i in r)t.call(r,i)&&(e[i]=r[i]);return o.prototype=r.prototype,e.prototype=new o,e.__super__=r.prototype,e};Backbone.SharedModel=function(t){function r(t,e){r.__super__.constructor.call(this,t,e),this.doc=null!=e?e.doc:void 0,this.collection||this.initializeSharing()}return e(r,t),r.prototype.initializeSharing=function(){var t=this;return this.collection&&(this.doc=this.collection.doc),this.sharedCollections&&_.each(this.sharedCollections,function(e){var r;return null!=(r=t[e])?r.initializeSharing({parent:t,doc:t.doc}):void 0}),this.sharedAttributes&&_.each(this.sharedAttributesKeys,function(e){return t.on("change:"+e,function(r,o){return t.updateSharedAttr(e,t._previousAttributes[e],o)})}),this.on("destroy",this.destroyed,this)},r.prototype.sharePath=function(){var t;return(null!=(t=this.collection)?t.sharePath().concat([this.index]):void 0)||[]},r.prototype.subDoc=function(){return this.doc.at(this.sharePath())},r.prototype.attrSubdoc=function(t){return this.subDoc().at([t])},r.prototype.sharedAttributes=function(){return _.pick(this.attributes,this.sharedAttributesKeys)},r.prototype.updateSharedAttr=function(t,e,r){return this.attrSubdoc(t).set(r)},r.prototype.destroyed=function(t,e,r){return(null!=r?r.fromSharedOp:void 0)?void 0:this.subDoc().remove()},r.prototype.applySharedAction=function(t){var e=this;return _.each(t,function(t){return t.li&&e.insertModel(t),t.oi&&e.setAttributeOrCollection(t),t.ld?e.destroyModel(t):void 0})},r.prototype.resourceAt=function(t){var e;return e=function(t,e){return _.isNumber(e)?t.models[e]:t[e]},_.reduce(t,e,this)},r.prototype.insertModel=function(t){var e;return e=this.resourceAt(_.initial(t.p)),e.add(t.li,{fromSharedOp:!0})},r.prototype.destroyModel=function(t){var e;return e=this.resourceAt(t.p),e.destroy({fromSharedOp:!0})},r.prototype.setAttributeOrCollection=function(t){var e,r,o;return o=this.resourceAt(_.initial(t.p)),r=_.last(t.p),(e=o[r])&&_.contains(o.sharedCollections,r)?e.reset(t.oi,{silent:!1,fromSharedOp:!0}):o.set(r,t.oi)},r}(Backbone.Model),Backbone.SharedCollection=function(t){function r(t,e){var o=this;r.__super__.constructor.call(this,t,e),this.on("add destroy",function(){return o.processIndexes()}),this.on("reset",function(){return o.setDoc()})}return e(r,t),r.prototype.path=null,r.prototype.initializeSharing=function(t){return this.on("add",this.triggerSharedAdd,this),this.parent=t.parent,this.setDoc(t.doc),this.processIndexes(),_.each(this.models,function(t){return t.initializeSharing()})},r.prototype.subdoc=function(){return this.doc.at(this.sharePath())},r.prototype.setDoc=function(t){var e;null==t&&(t=null),t&&(this.doc=t);try{if(this.subdoc().get(),e=this.sharePath().join("-"),this.listening!==e)return this.listening=e}catch(r){}},r.prototype.sharePath=function(){return this.parent.sharePath().concat([this.path])},r.prototype.processIndexes=function(){return this.each(function(t,e){return t.index=e,t.trigger("indexed")})},r.prototype.modelAdded=function(t){return void 0===this.subdoc().get()?(this.subdoc().set([t.sharedAttributes()]),this.setDoc()):this.subdoc().push(t.sharedAttributes())},r.prototype.triggerSharedAdd=function(t,e,r){return t.initializeSharing(),r&&r.fromSharedOp?void 0:this.modelAdded(t)},r}(Backbone.Collection)}).call(this);