(function(){var t={}.hasOwnProperty,o=function(o,r){function e(){this.constructor=o}for(var i in r)t.call(r,i)&&(o[i]=r[i]);return e.prototype=r.prototype,o.prototype=new e,o.__super__=r.prototype,o};Backbone.SharedModel=function(t){function r(t,o){r.__super__.constructor.call(this,t,o),this.doc=null!=o?o.doc:void 0,(null!=o?o.root:void 0)&&(this.root=o.root),this.root&&this.initializeSharing()}return o(r,t),r.prototype.root=!1,r.prototype.initializeSharing=function(){var t=this;return this.root||(this.doc=this.collection.doc),this.sharedCollections&&_.each(this.sharedCollections,function(o){var r;return null!=(r=t[o])?r.initializeSharing({parent:t,doc:t.doc}):void 0}),this.sharedAttributes&&_.each(this.sharedAttributesKeys,function(o){return t.on("change:"+o,function(r,e){return t.updateSharedAttr(o,t._previousAttributes[o],e)})}),this.on("destroy",this.destroyed,this)},r.prototype.sharePath=function(){var t;return(null!=(t=this.collection)?t.sharePath().concat([this.index]):void 0)||[]},r.prototype.subDoc=function(){return this.doc.at(this.sharePath())},r.prototype.attrSubdoc=function(t){return this.subDoc().at([t])},r.prototype.sharedAttributes=function(){return _.pick(this.attributes,this.sharedAttributesKeys)},r.prototype.updateSharedAttr=function(t,o,r){return this.attrSubdoc(t).set(r)},r.prototype.destroyed=function(t,o,r){return(null!=r?r.fromSharedOp:void 0)?void 0:this.subDoc().remove()},r.prototype.applySharedAction=function(t){var o=this;return _.each(t,function(t){return t.li&&o.insertModel(t),t.oi&&o.setAttributeOrCollection(t),t.ld?o.destroyModel(t):void 0})},r.prototype.resourceAt=function(t){var o;return o=function(t,o){return _.isNumber(o)?t.models[o]:t[o]},_.reduce(t,o,this)},r.prototype.insertModel=function(t){var o;return o=this.resourceAt(_.initial(t.p)),o.add(t.li,{fromSharedOp:!0})},r.prototype.destroyModel=function(t){var o;return o=this.resourceAt(t.p),o.destroy({fromSharedOp:!0})},r.prototype.setAttributeOrCollection=function(t){var o,r,e;return e=this.resourceAt(_.initial(t.p)),r=_.last(t.p),(o=e[r])&&_.contains(e.sharedCollections,r)?o.reset(t.oi,{silent:!1,fromSharedOp:!0}):e.set(r,t.oi)},r}(Backbone.Model),Backbone.SharedCollection=function(t){function r(t,o){var e=this;r.__super__.constructor.call(this,t,o),this.on("add destroy",function(){return e.processIndexes()}),this.on("reset",function(){return e.setDoc()})}return o(r,t),r.prototype.path=null,r.prototype.initializeSharing=function(t){var o,r=this;return this.on("add",this.triggerSharedAdd,this),this.parent=t.parent,this.setDoc(t.doc),this.processIndexes(),o=!this.subDoc().get(),_.each(this.models,function(t){return t.initializeSharing(),o?r.modelAdded(t):void 0})},r.prototype.subDoc=function(){return this.doc.at(this.sharePath())},r.prototype.setDoc=function(t){var o;null==t&&(t=null),t&&(this.doc=t);try{if(this.subDoc().get(),o=this.sharePath().join("-"),this.listening!==o)return this.listening=o}catch(r){}},r.prototype.sharePath=function(){return this.parent.sharePath().concat([this.path])},r.prototype.processIndexes=function(){return this.each(function(t,o){return t.index=o,t.trigger("indexed")})},r.prototype.modelAdded=function(t){return void 0===this.subDoc().get()?(this.subDoc().set([t.sharedAttributes()]),this.setDoc()):this.subDoc().push(t.sharedAttributes())},r.prototype.triggerSharedAdd=function(t,o,r){return t.root||t.collection?(r&&r.fromSharedOp||this.modelAdded(t),t.initializeSharing()):void 0},r}(Backbone.Collection)}).call(this);